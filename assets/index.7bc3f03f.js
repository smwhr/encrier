var B=Object.defineProperty,W=Object.defineProperties;var G=Object.getOwnPropertyDescriptors;var H=Object.getOwnPropertySymbols;var J=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable;var $=(o,t,n)=>t in o?B(o,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[t]=n,C=(o,t)=>{for(var n in t||(t={}))J.call(t,n)&&$(o,n,t[n]);if(H)for(var n of H(t))Y.call(t,n)&&$(o,n,t[n]);return o},R=(o,t)=>W(o,G(t));var M=(o,t,n)=>($(o,typeof t!="symbol"?t+"":t,n),n);import{C as L,j as i,a as w,u as V,r as l,i as q,R as z,b as Q}from"./vendor.f43ac392.js";const X=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))r(e);new MutationObserver(e=>{for(const s of e)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function n(e){const s={};return e.integrity&&(s.integrity=e.integrity),e.referrerpolicy&&(s.referrerPolicy=e.referrerpolicy),e.crossorigin==="use-credentials"?s.credentials="include":e.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(e){if(e.ep)return;e.ep=!0;const s=n(e);fetch(e.href,s)}};X();class T extends Error{}class Z{constructor(t){M(this,"ResolveInkFilename",t=>{if(Object.keys(this.fileHierarchy).includes(`inmemory://model/${t}`))return t;throw new T(`RUNTIME ERROR: '${t}' line 0: Cannot locate file ${t}.`)});M(this,"LoadInkFileContents",t=>{if(Object.keys(this.fileHierarchy).includes(`inmemory://model/${t}`))return this.fileHierarchy[`inmemory://model/${t}`];throw new T(`RUNTIME ERROR: '${t}' line 0: Cannot open file ${t}.`)});M(this,"update",(t,n)=>(this.fileHierarchy[t]=n,this));M(this,"delete",t=>(delete this.fileHierarchy[t],this));this.fileHierarchy=t}}const ee=(o,t)=>{const n=[],r=(c,p)=>{var v=/^(ERROR|WARNING|RUNTIME ERROR|RUNTIME WARNING|TODO): ('([^']+)' )?line (\d+): (.*)/;let f=c.match(v);if(f){const x=f[1],k=f[3],g=parseInt(f[4]),E=f[5],d=/\n/gi,m=[0];let y=null;for(;y=d.exec(o);)m.push(y.index+1);const S=m[g-1]||0,N={type:x,filename:k,lineNumber:g,index:S,msg:E};n.push(N)}},e=new L.CompilerOptions(null,[],!1,r,t.fileHandler),s=new L.Compiler(o,e);try{const c=s.Compile(),p=s.parsedStory;return{story:c,parsedStory:p,parseErrors:n}}catch(c){return c instanceof T&&r(c.message),{story:void 0,parsedStory:void 0,parseErrors:n}}},te=o=>o.GetType()=="Knot",oe=o=>[{label:"choice",kind:o.languages.CompletionItemKind.Snippet,insertText:"* ${1:text}",insertTextRules:o.languages.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Simple choice"},{label:"labeled-choice",kind:o.languages.CompletionItemKind.Snippet,insertText:"*(${2:label}) ${1:text}",insertTextRules:o.languages.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Labeled choice"}],ne=o=>{const{visible:t,fileHandler:n}=o,r=Object.keys(n.fileHierarchy).map(e=>e.replace("inmemory://model/",""));return i("div",{className:`split-view-view ${t?"visible":""} files-bar`,style:{left:"48px",width:"120px",height:"100%"},children:i("div",{className:"monaco-list",children:i("div",{className:"monaco-scrollable-element",children:i("div",{className:"monaco-list-rows",children:r.map(e=>i("div",{className:"monaco-list-row",children:i("div",{className:"monaco-tl-row",children:i("div",{className:"monaco-tl-contents",children:i("div",{className:"monaco-icon-label",children:w("div",{className:"monaco-icon-label-container",children:[i("span",{className:"monaco-icon-name-container",children:i("a",{className:"label-name",children:i("span",{children:e})})}),i("span",{className:"monaco-icon-description-container"})]})})})})},e))})})})})},P=function(o,t){const n=document.createElement("a"),r=window.URL.createObjectURL(o);n.href=r,n.download=t,n.click(),window.URL.revokeObjectURL(r)},se=async function(o="*",t=!1){return new Promise(n=>{const r=document.createElement("input");r.setAttribute("type","file"),r.addEventListener("change",()=>{var e;if(((e=r.files)==null?void 0:e.length)||0>0){const s=r.files[0];re(s).then(c=>{n({filename:s.name,content:c})})}r.remove()}),r.click()})},re=async function(o){return new Promise((t,n)=>{const r=new FileReader;r.onerror=n,r.onload=()=>t(r.result),r.readAsText(o)})},ie=({setStory:o,className:t,showFileManager:n})=>{const r=`LIST letters = a,b,c
    Once upon a time...
    -(opts)
    + Choice A.
    + Choice B.
    + Choice C.
        ->knot
   
   - They lived happily ever after {opts}.
       -> opts

== knot ==
Another castle
->END
   `,e=V(),s=l.exports.useRef(null),[c,p]=l.exports.useState(r),[v,f]=l.exports.useState(),[x,k]=l.exports.useState(),[g,E]=l.exports.useState(),[d,m]=l.exports.useState([]),[y,S]=l.exports.useState(new Z({"inmemory://model/1":r}));l.exports.useEffect(()=>{if(e&&s.current&&g){const a=s.current;let u=g.map(h=>({range:new e.Range(h.lineNumber,1,h.lineNumber,1),options:{isWholeLine:!0,glyphMarginClassName:h.type.includes("ERROR")?"errorIcon":h.type.includes("WARNING")?"warningIcon":"infoIcon",glyphMarginHoverMessage:{value:h.msg}}}));m(a.deltaDecorations(d,u))}},[e,s,g]),l.exports.useEffect(()=>{if(e&&x){const a=e.languages.registerFoldingRangeProvider("ink",{provideFoldingRanges:function(){return x.content.filter(u=>u.debugMetadata!==null).map(u=>({start:u.debugMetadata.startLineNumber,end:Math.max(u.debugMetadata.startLineNumber,u.debugMetadata.endLineNumber-1),kind:e.languages.FoldingRangeKind.Region}))}});return()=>{a.dispose()}}},[e,x]),l.exports.useEffect(()=>{if(e&&x){const a=e.languages.registerCompletionItemProvider("ink",{provideCompletionItems:function(){const u=x.content.filter(b=>b.debugMetadata!==null).filter(te).map(b=>({label:b.name,kind:e.languages.CompletionItemKind.Text,insertText:`-> ${b.name}`})),h=oe(e);return{suggestions:u.concat(h)}}});return()=>{a.dispose()}}},[e,x]),l.exports.useEffect(()=>{const{story:a,parsedStory:u,parseErrors:h}=ee(c,{fileHandler:y});a&&(o(a),f(a)),k(u),E(h)},[c,e,s]);const N=a=>{a&&p(a)},O=(a,u)=>()=>{se().then(({filename:h,content:b})=>{console.log(b);var K=u.editor.createModel(b,"ink",`inmemory://model/${h}`);const F=a.getModel();F.dispose(),a.setModel(K),y.delete(`${F.uri}`).update(`${K.uri}`,c),p(b),S(y)})},I=()=>{if(v){const a=new Blob([v.ToJson()],{type:"application/json"});P(a,"main.ink.json")}else alert("There are errors to fix first.")},_=()=>{if(c){const a=new Blob([c],{type:"text/plain"});P(a,"main.ink")}else alert("File is empty")};l.exports.useEffect(()=>{if(!s.current||!e)return;const a=s.current,u=a.addAction({id:"save_json",label:"Save as JSON",keybindings:[e.KeyMod.CtrlCmd|e.KeyMod.Shift|e.KeyCode.KEY_S],run:I}),h=a.addAction({id:"save_story",label:"Save story",keybindings:[e.KeyMod.CtrlCmd|e.KeyCode.KEY_S],run:_}),b=a.addAction({id:"open_story",label:"Open story (ink)",keybindings:[e.KeyMod.CtrlCmd|e.KeyMod.Shift|e.KeyCode.KEY_O,e.KeyMod.CtrlCmd|e.KeyCode.KEY_O],run:O(a,e)});return()=>{u.dispose(),h.dispose(),b.dispose()}},[s,v,c]);const U=(a,u)=>{s.current=a,u.languages.register({id:"ink"})};return w("div",{className:`editor-wrapper ${t} ${n?"with-filemanager":""}`,children:[i(ne,{visible:n,fileHandler:y}),i(q,{className:"editor",theme:"vs-dark",height:"100%",width:"auto",defaultValue:c,language:"ink",onChange:N,onMount:U,options:{glyphMargin:!0,lineDecorationsWidth:2,lineNumbers:"off"}})]})},ce=(o,t)=>({text:o,index:t,delay:0}),j=(o,t=[])=>({text:o,classList:t,delay:0}),D={texts:[],choices:[]};function ae(o,t){switch(t.type){case"reset":return D;case"add_text":return R(C({},o),{texts:o.texts.concat(t.payload)});case"delay_text":const{index:n,delay:r}=t.payload,e=o.texts;return e[n].delay=r,R(C({},o),{texts:e});case"add_choice":return R(C({},o),{choices:o.choices.concat(t.payload)});case"delay_choice":const{index:s,delay:c}=t.payload,p=o.choices;return p[s].delay=c,R(C({},o),{choices:p});case"clear_choices":return R(C({},o),{choices:[]});default:throw new Error}}const le=({story:o,className:t})=>{const[n,r]=l.exports.useState(o),[e,s]=l.exports.useReducer(ae,D),[c,p]=l.exports.useState([]),v=l.exports.useRef(e.texts),f=l.exports.useRef(null),x=()=>{if(n===null)return;const d=c.slice(0,-1);console.log("rewind",d),n.ResetState(),p(d),r(n)};if(l.exports.useEffect(()=>{o!==null&&r(o)},[o]),l.exports.useLayoutEffect(()=>{if(n!==null){for(let d of c)try{console.log("autopilot",d),A(n,s,d)}catch{console.log(`Could not choose ${d}`),p(c.slice(0,c.indexOf(d)));break}return A(n,s),()=>{s({type:"reset"})}}},[n]),l.exports.useLayoutEffect(()=>{if(f.current===null)return;const d=v.current,m=e.texts;let y=0;for(let N of m)if(d.indexOf(N)===-1){const I=m.indexOf(N),_=y*200;s({type:"delay_text",payload:{index:I,delay:_}}),y++}for(let N of g){if(N.delay>0)continue;const O=g.indexOf(N),I=y*200;s({type:"delay_choice",payload:{index:O,delay:I}}),y++}v.current=m;const S=f.current.querySelector("p:last-child");S&&S.scrollIntoView({behavior:"smooth",block:"end",inline:"nearest"})},[n,e.texts,e.choices]),n===null)return null;const{texts:k,choices:g}=e,E=d=>m=>{m.preventDefault(),s({type:"clear_choices"}),p(c.concat(d)),n.ChooseChoiceIndex(d),A(n,s)};return w("div",{className:"player-wrapper",children:[i("div",{className:"toolbar ",children:i("div",{className:"actions-container",children:i("div",{className:"action-item icon",children:i("a",{className:"action-label codicon codicon-debug-step-back",style:{color:"rgb(248, 248, 242)"},onClick:x})})})}),w("div",{className:`container ${t}`,ref:f,children:[k.map((d,m)=>i("p",{style:{animationDelay:d.delay+200+"ms"},children:d.text},m)),g.length>0&&g.map(d=>i("p",{className:"choice",style:{animationDelay:d.delay+200+"ms"},children:i("a",{href:"#",onClick:E(d.index),children:d.text})},`choice-${c.length}-${d.index}`)),i("p",{})]})]})};function A(o,t,n){for(;o.canContinue;){var r=o.Continue(),e=o.currentTags;t({type:"add_text",payload:j(r)}),e&&e.length>0&&t({type:"add_text",payload:j(e.map(s=>`#${s}`).join(" "),["tags"])})}if(n!==void 0){o.ChooseChoiceIndex(n);return}o.currentChoices.forEach(function(s,c){t({type:"add_choice",payload:ce(s.text,s.index)})})}const de=({toggleFileManager:o,playerActive:t,setPlayerActive:n,editorActive:r,setEditorActive:e})=>i("div",{className:"left-bar",children:i("div",{className:"monaco-action-bar vertical",children:w("ul",{className:"actions-container",role:"toolbar","aria-label":"Active View Switcher",children:[w("li",{className:"action-item icon checked mobile-show",role:"tab",children:[i("a",{className:"action-label codicon codicon-edit-icon",style:{color:"rgb(248, 248, 242)"},onClick:()=>{n(!1),e(!0)}}),i("div",{className:"active-item-indicator"})]}),r&&w("li",{className:"action-item icon",role:"tab",children:[i("a",{className:"action-label codicon codicon-explorer-view-icon",style:{color:"rgb(248, 248, 242)"},onClick:o}),i("div",{className:"active-item-indicator"})]}),w("li",{className:"action-item icon checked mobile-show",role:"tab",children:[i("a",{className:"action-label codicon codicon-play-icon",style:{color:"rgb(248, 248, 242)"},onClick:()=>{n(!0),e(!1)}}),i("div",{className:"active-item-indicator"})]})]})})});function ue(){l.exports.useState(0);const[o,t]=l.exports.useState(null),[n,r]=l.exports.useState(!0),[e,s]=l.exports.useState(!1),[c,p]=l.exports.useState(!1);return i("div",{className:"App",children:w("div",{className:"row",children:[i(de,{toggleFileManager:()=>{p(!c)},playerActive:n,setPlayerActive:r,editorActive:e,setEditorActive:s}),i(ie,{className:e?"":"mobile-hide",setStory:t,showFileManager:c}),i(le,{story:o,className:n?"":"mobile-hide"})]})})}z.render(i(Q.StrictMode,{children:i(ue,{})}),document.getElementById("root"));
