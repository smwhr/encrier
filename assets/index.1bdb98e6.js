var D=Object.defineProperty,L=Object.defineProperties;var w=Object.getOwnPropertyDescriptors;var E=Object.getOwnPropertySymbols;var k=Object.prototype.hasOwnProperty,_=Object.prototype.propertyIsEnumerable;var S=(e,t,n)=>t in e?D(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,g=(e,t)=>{for(var n in t||(t={}))k.call(t,n)&&S(e,n,t[n]);if(E)for(var n of E(t))_.call(t,n)&&S(e,n,t[n]);return e},m=(e,t)=>L(e,w(t));import{C as I,u as A,r as d,j as h,i as P,a as b,R as T,b as $}from"./vendor.f43ac392.js";const W=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerpolicy&&(r.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?r.credentials="include":o.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}};W();const j=e=>{const t=[],n=(r,a)=>{var y=/^(ERROR|WARNING|RUNTIME ERROR|RUNTIME WARNING|TODO): ('([^']+)' )?line (\d+): (.*)/;let p=r.match(y);if(p){const R=p[1],s=p[3],f=parseInt(p[4]),x=p[5],N=/\n/gi,c=[0];let l=null;for(;l=N.exec(e);)c.push(l.index+1);const u=c[f-1]||0,v={type:R,filename:s,lineNumber:f,index:u,msg:x};t.push(v)}},i=new I.CompilerOptions(null,[],!1,n,null),o=new I.Compiler(e,i);try{const r=o.Compile(),a=o.parsedStory;return{story:r,parsedStory:a,parseErrors:t}}catch{return{story:void 0,parsedStory:void 0,parseErrors:t}}},F=({setStory:e})=>{const t=`LIST letters = a,b,c
    Once upon a time...
    -(opts)
    + Choice A.
    + Choice B.
    + Choice C.
        ->knot
   
   - They lived happily ever after {opts}.
       -> opts

== knot ==
Another castle
->END
   `,n=A(),i=d.exports.useRef(null),[o,r]=d.exports.useState(t),[a,y]=d.exports.useState(),[p,R]=d.exports.useState(),[s,f]=d.exports.useState([]);return d.exports.useEffect(()=>{if(n&&i.current&&p){const c=i.current;let l=p.map(u=>({range:new n.Range(u.lineNumber,1,u.lineNumber,1),options:{isWholeLine:!0,glyphMarginClassName:u.type.includes("ERROR")?"errorIcon":u.type.includes("WARNING")?"warningIcon":"infoIcon",linesDecorationsClassName:u.type.includes("ERROR")?"errorLineDecoration":u.type.includes("WARNING")?"warningLineDecoration":"infoLineDecoration",glyphMarginHoverMessage:{value:u.msg}}}));f(c.deltaDecorations(s,l))}},[n,i,p]),d.exports.useEffect(()=>{if(n&&a){const c=n.languages.registerFoldingRangeProvider("ink",{provideFoldingRanges:function(){return a.content.filter(l=>l.debugMetadata!==null).map(l=>({start:l.debugMetadata.startLineNumber,end:Math.max(l.debugMetadata.startLineNumber,l.debugMetadata.endLineNumber-1),kind:n.languages.FoldingRangeKind.Region}))}});return()=>{c.dispose()}}},[n,a]),d.exports.useEffect(()=>{const{story:c,parsedStory:l,parseErrors:u}=j(o);c&&e(c),y(l),R(u)},[o,n]),h(P,{className:"editor",theme:"vs-dark",height:"100vh",defaultValue:o,language:"ink",onChange:c=>{c&&r(c)},onMount:(c,l)=>{i.current=c,l.languages.register({id:"ink"})},options:{glyphMargin:!0}})},G=(e,t)=>({text:e,index:t,delay:0}),M=(e,t=[])=>({text:e,classList:t,delay:0}),O={texts:[],choices:[]};function H(e,t){switch(t.type){case"reset":return O;case"add_text":return m(g({},e),{texts:e.texts.concat(t.payload)});case"delay_text":const{index:n,delay:i}=t.payload,o=e.texts;return o[n].delay=i,m(g({},e),{texts:o});case"add_choice":return m(g({},e),{choices:e.choices.concat(t.payload)});case"delay_choice":const{index:r,delay:a}=t.payload,y=e.choices;return y[r].delay=a,m(g({},e),{choices:y});case"clear_choices":return m(g({},e),{choices:[]});default:throw new Error}}const q=({story:e})=>{const[t,n]=d.exports.useReducer(H,O),[i,o]=d.exports.useState([]),r=d.exports.useRef(t.texts),a=d.exports.useRef(null);if(d.exports.useLayoutEffect(()=>{if(e!==null){for(let s of i)try{C(e,n,s)}catch{console.log(`Could not choose ${s}`),o(i.slice(0,i.indexOf(s)));break}return C(e,n),()=>{n({type:"reset"})}}},[e]),d.exports.useLayoutEffect(()=>{if(a.current===null)return;const s=r.current,f=t.texts;let x=0;for(let c of f)if(s.indexOf(c)===-1){const u=f.indexOf(c),v=x*200;n({type:"delay_text",payload:{index:u,delay:v}}),x++}for(let c of p){if(c.delay>0)continue;const l=p.indexOf(c),u=x*200;n({type:"delay_choice",payload:{index:l,delay:u}}),x++}r.current=f;const N=a.current.querySelector("p:last-child");N&&N.scrollIntoView({behavior:"smooth",block:"end",inline:"nearest"})},[e,t.texts,t.choices]),e===null)return null;const{texts:y,choices:p}=t,R=s=>f=>{f.preventDefault(),n({type:"clear_choices"}),o(i.concat(s)),e.ChooseChoiceIndex(s),C(e,n)};return b("div",{className:"container",ref:a,children:[y.map((s,f)=>h("p",{style:{animationDelay:s.delay+200+"ms"},children:s.text},f)),p.length>0&&p.map(s=>h("p",{className:"choice",style:{animationDelay:s.delay+200+"ms"},children:h("a",{href:"#",onClick:R(s.index),children:s.text})},`choice-${i.length}-${s.index}`)),h("p",{})]})};function C(e,t,n){for(;e.canContinue;){var i=e.Continue(),o=e.currentTags;t({type:"add_text",payload:M(i)}),o&&o.length>0&&t({type:"add_text",payload:M(o.map(r=>`#${r}`).join(" "),["tags"])})}if(n!==void 0){e.ChooseChoiceIndex(n);return}e.currentChoices.forEach(function(r,a){t({type:"add_choice",payload:G(r.text,r.index)})})}function B(){d.exports.useState(0);const[e,t]=d.exports.useState(null);return h("div",{className:"App",children:b("div",{className:"row",children:[h(F,{setStory:t}),h(q,{story:e})]})})}T.render(h($.StrictMode,{children:h(B,{})}),document.getElementById("root"));
