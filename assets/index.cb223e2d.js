var W=Object.defineProperty,G=Object.defineProperties;var J=Object.getOwnPropertyDescriptors;var K=Object.getOwnPropertySymbols;var Y=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable;var O=(n,e,o)=>e in n?W(n,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[e]=o,S=(n,e)=>{for(var o in e||(e={}))Y.call(e,o)&&O(n,o,e[o]);if(K)for(var o of K(e))V.call(e,o)&&O(n,o,e[o]);return n},C=(n,e)=>G(n,J(e));var E=(n,e,o)=>(O(n,typeof e!="symbol"?e+"":e,o),o);import{C as L,j as a,a as w,u as q,r as l,i as z,R as Q,b as X}from"./vendor.f43ac392.js";const Z=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))i(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function o(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerpolicy&&(s.referrerPolicy=t.referrerpolicy),t.crossorigin==="use-credentials"?s.credentials="include":t.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(t){if(t.ep)return;t.ep=!0;const s=o(t);fetch(t.href,s)}};Z();class T extends Error{}class ee{constructor(e){E(this,"ResolveInkFilename",e=>{if(Object.keys(this.fileHierarchy).includes(`file:///${e}`))return e;throw new T(`RUNTIME ERROR: '${e}' line 0: Cannot locate file ${e}.`)});E(this,"LoadInkFileContents",e=>{if(Object.keys(this.fileHierarchy).includes(`file:///${e}`))return this.fileHierarchy[`file:///${e}`];throw new T(`RUNTIME ERROR: '${e}' line 0: Cannot open file ${e}.`)});E(this,"update",(e,o)=>(this.fileHierarchy[e]=o,this));E(this,"delete",e=>(delete this.fileHierarchy[e],this));this.fileHierarchy=e}}const te=(n,e)=>{const o=[],i=(r,p)=>{var y=/^(ERROR|WARNING|RUNTIME ERROR|RUNTIME WARNING|TODO): ('([^']+)' )?line (\d+): (.*)/;let m=r.match(y);if(m){const b=m[1],I=m[3],x=parseInt(m[4]),k=m[5],d=/\n/gi,h=[0];let g=null;for(;g=d.exec(n);)h.push(g.index+1);const v=h[x-1]||0,R={type:b,filename:I,lineNumber:x,index:v,msg:k};o.push(R)}},t=new L.CompilerOptions(null,[],!1,i,e.fileHandler),s=new L.Compiler(n,t);try{const r=s.Compile(),p=s.parsedStory;return{story:r,parsedStory:p,parseErrors:o}}catch(r){return r instanceof T&&i(r.message),{story:void 0,parsedStory:void 0,parseErrors:o}}},ne=n=>n.GetType()=="Knot",oe=n=>[{label:"choice",kind:n.languages.CompletionItemKind.Snippet,insertText:"* ${1:text}",insertTextRules:n.languages.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Simple choice"},{label:"labeled-choice",kind:n.languages.CompletionItemKind.Snippet,insertText:"*(${2:label}) ${1:text}",insertTextRules:n.languages.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Labeled choice"}],se=n=>{const{visible:e,fileHandler:o}=n,i=Object.keys(o.fileHierarchy).map(t=>t.replace("file:///",""));return a("div",{className:`split-view-view ${e?"visible":""} files-bar`,style:{left:"48px",width:"120px",height:"100%"},children:a("div",{className:"monaco-list",children:a("div",{className:"monaco-scrollable-element",children:a("div",{className:"monaco-list-rows",children:i.map(t=>a("div",{className:"monaco-list-row",children:a("div",{className:"monaco-tl-row",children:a("div",{className:"monaco-tl-contents",children:a("div",{className:"monaco-icon-label",children:w("div",{className:"monaco-icon-label-container",children:[a("span",{className:"monaco-icon-name-container",children:a("a",{className:"label-name",children:a("span",{children:t})})}),a("span",{className:"monaco-icon-description-container"})]})})})})},t))})})})})},H=function(n,e){const o=document.createElement("a"),i=window.URL.createObjectURL(n);o.href=i,o.download=e,o.click(),window.URL.revokeObjectURL(i)},ie=async function(n="*",e=!1){return new Promise(o=>{const i=document.createElement("input");i.setAttribute("type","file"),i.addEventListener("change",()=>{var t;if(((t=i.files)==null?void 0:t.length)||0>0){const s=i.files[0];re(s).then(r=>{o({filename:s.name,content:r})})}i.remove()}),i.click()})},re=async function(n){return new Promise((e,o)=>{const i=new FileReader;i.onerror=o,i.onload=()=>e(i.result),i.readAsText(n)})},ae=({setStory:n,className:e,showFileManager:o})=>{const i=`LIST letters = a,b,c
    Once upon a time...
    -(opts)
    + Choice A.
    + Choice B.
    + Choice C.
        ->knot
   
   - They lived happily ever after {opts}.
       -> opts

== knot ==
Another castle
->END
   `,t=q(),s=l.exports.useRef(null),[r,p]=l.exports.useState(i),[y,m]=l.exports.useState(),[b,I]=l.exports.useState(),[x,k]=l.exports.useState(),[d,h]=l.exports.useState([]),[g,v]=l.exports.useState(new ee({"file:///default.ink":i}));l.exports.useEffect(()=>{if(t&&s.current&&x){const c=s.current;let u=x.map(f=>({range:new t.Range(f.lineNumber,1,f.lineNumber,1),options:{isWholeLine:!0,glyphMarginClassName:f.type.includes("ERROR")?"errorIcon":f.type.includes("WARNING")?"warningIcon":"infoIcon",glyphMarginHoverMessage:{value:f.msg}}}));h(c.deltaDecorations(d,u))}},[t,s,x]),l.exports.useEffect(()=>{if(t&&b){const c=t.languages.registerFoldingRangeProvider("ink",{provideFoldingRanges:function(){return b.content.filter(u=>u.debugMetadata!==null).map(u=>({start:u.debugMetadata.startLineNumber,end:Math.max(u.debugMetadata.startLineNumber,u.debugMetadata.endLineNumber-1),kind:t.languages.FoldingRangeKind.Region}))}});return()=>{c.dispose()}}},[t,b]),l.exports.useEffect(()=>{if(t&&b){const c=t.languages.registerCompletionItemProvider("ink",{provideCompletionItems:function(){const u=b.content.filter(N=>N.debugMetadata!==null).filter(ne).map(N=>({label:N.name,kind:t.languages.CompletionItemKind.Text,insertText:`-> ${N.name}`})),f=oe(t);return{suggestions:u.concat(f)}}});return()=>{c.dispose()}}},[t,b]),l.exports.useEffect(()=>{const{story:c,parsedStory:u,parseErrors:f}=te(r,{fileHandler:g});c&&(n(c),m(c)),I(u),k(f)},[r,t,s]);const R=c=>{c&&p(c)},M=(c,u)=>()=>{ie().then(({filename:f,content:N})=>{var _=u.editor.createModel(N,"ink",`file:///${f}`);const $=c.getModel();debugger;$.dispose(),c.setModel(_),g.delete(`${$.uri}`).update(`${_.uri}`,r),p(N),v(g)})},D=()=>{if(y){const c=new Blob([y.ToJson()],{type:"application/json"});H(c,"main.ink.json")}else alert("There are errors to fix first.")},U=()=>{if(r){const c=new Blob([r],{type:"text/plain"});H(c,"main.ink")}else alert("File is empty")};l.exports.useEffect(()=>{if(!s.current||!t)return;const c=s.current,u=c.addAction({id:"save_json",label:"Save as JSON",keybindings:[t.KeyMod.CtrlCmd|t.KeyMod.Shift|t.KeyCode.KEY_S],run:D}),f=c.addAction({id:"save_story",label:"Save story",keybindings:[t.KeyMod.CtrlCmd|t.KeyCode.KEY_S],run:U}),N=c.addAction({id:"open_story",label:"Open story (ink)",keybindings:[t.KeyMod.CtrlCmd|t.KeyMod.Shift|t.KeyCode.KEY_O,t.KeyMod.CtrlCmd|t.KeyCode.KEY_O],run:M(c,t)});return()=>{u.dispose(),f.dispose(),N.dispose()}},[s,y,r]);const B=(c,u)=>{s.current=c,u.languages.register({id:"ink"})};return w("div",{className:`editor-wrapper ${e} ${o?"with-filemanager":""}`,children:[a(se,{visible:o,fileHandler:g}),a(z,{className:"editor",theme:"vs-dark",height:"100%",width:"100%",defaultValue:r,language:"ink",path:"default.ink",onChange:R,onMount:B,options:{glyphMargin:!0,lineDecorationsWidth:2,lineNumbers:"off"}})]})},ce=(n,e)=>({text:n,index:e,delay:null}),F=(n,e=[])=>({text:n,classList:e,delay:null});function P(n,e){return C(S({},n),{delay:e})}const j={texts:[],choices:[],delayIndex:1};function le(n,e){switch(e.type){case"reset":return j;case"add_text":return C(S({},n),{texts:n.texts.concat(e.payload)});case"delay_text":const{index:o}=e.payload,i=n.texts,t=i[o],s=t.delay===null?n.delayIndex:t.delay;return i[o].delay=s,s===0&&i[o].classList.push("no-animation"),C(S({},n),{texts:i,delayIndex:s===0?1:n.delayIndex+1});case"add_choice":return C(S({},n),{choices:n.choices.concat(e.payload)});case"delay_choice":const{index:r}=e.payload,p=n.choices,y=p[r],m=y.delay===null?n.delayIndex:y.delay;return p[r].delay=m,C(S({},n),{choices:p,delayIndex:n.delayIndex+1});case"clear_choices":return C(S({},n),{choices:[],delayIndex:1});default:throw new Error}}const de=({story:n,className:e})=>{const[o,i]=l.exports.useState(n),[t,s]=l.exports.useReducer(le,j),[r,p]=l.exports.useState([]),y=l.exports.useRef(t.texts),m=l.exports.useRef(null),b=()=>{if(o===null)return;const d=r.slice(0,-1);o.ResetState(),p(d),i(null),setTimeout(()=>{i(o)},0)};if(l.exports.useEffect(()=>{i(n)},[n]),l.exports.useLayoutEffect(()=>{if(o!==null){for(let d of r)try{A(o,s,d)}catch{console.log(`Could not choose ${d}`),p(r.slice(0,r.indexOf(d)));break}return A(o,s,null),()=>{s({type:"reset"})}}},[o]),l.exports.useLayoutEffect(()=>{if(m.current===null)return;const d=y.current,h=t.texts;for(let v of h)if(d.indexOf(v)===-1){const M=h.indexOf(v);s({type:"delay_text",payload:{index:M}})}for(let v of x){if(v.delay!==null)continue;const R=x.indexOf(v);s({type:"delay_choice",payload:{index:R}})}y.current=h;const g=m.current.querySelector("p:last-child");g&&g.scrollIntoView({behavior:"smooth",block:"end",inline:"nearest"})},[o,t.texts,t.choices]),o===null)return null;const{texts:I,choices:x}=t,k=d=>h=>{h.preventDefault(),s({type:"clear_choices"});const g=[...r,d];p(g),o.ChooseChoiceIndex(d),A(o,s)};return w("div",{className:"player-wrapper",children:[a("div",{className:"toolbar ",children:a("div",{className:"actions-container",children:a("div",{className:"action-item icon",children:a("a",{className:"action-label codicon codicon-debug-step-back",style:{color:"rgb(248, 248, 242)"},onClick:b})})})}),w("div",{className:`container ${e}`,ref:m,children:[I.map((d,h)=>a("p",{className:d.classList.join(" "),style:{animationDelay:d.delay*200+"ms"},children:d.text},h)),x.length>0&&x.map(d=>a("p",{className:"choice",style:{animationDelay:d.delay*200+"ms"},children:a("a",{href:"#",onClick:k(d.index),children:d.text})},`choice-${r.length}-${d.index}`)),a("p",{})]})]})};function A(n,e,o){const i=o!==void 0?0:null;for(;n.canContinue;){var t=n.Continue(),s=n.currentTags;e({type:"add_text",payload:P(F(t),i)}),s&&s.length>0&&e({type:"add_text",payload:P(F(s.map(r=>`#${r}`).join(" "),["tags"]),i)})}if(o!=null){n.ChooseChoiceIndex(o);return}n.currentChoices.forEach(function(r,p){e({type:"add_choice",payload:ce(r.text,r.index)})})}const ue=({toggleFileManager:n,playerActive:e,setPlayerActive:o,editorActive:i,setEditorActive:t})=>a("div",{className:"left-bar",children:a("div",{className:"monaco-action-bar vertical",children:w("ul",{className:"actions-container",role:"toolbar","aria-label":"Active View Switcher",children:[w("li",{className:"action-item icon checked mobile-show",role:"tab",children:[a("a",{className:"action-label codicon codicon-edit-icon",style:{color:"rgb(248, 248, 242)"},onClick:()=>{o(!1),t(!0)}}),a("div",{className:"active-item-indicator"})]}),i&&w("li",{className:"action-item icon",role:"tab",children:[a("a",{className:"action-label codicon codicon-explorer-view-icon",style:{color:"rgb(248, 248, 242)"},onClick:n}),a("div",{className:"active-item-indicator"})]}),w("li",{className:"action-item icon checked mobile-show",role:"tab",children:[a("a",{className:"action-label codicon codicon-play-icon",style:{color:"rgb(248, 248, 242)"},onClick:()=>{o(!0),t(!1)}}),a("div",{className:"active-item-indicator"})]})]})})});function pe(){const[n,e]=l.exports.useState(null),[o,i]=l.exports.useState(!1),[t,s]=l.exports.useState(!0),[r,p]=l.exports.useState(!1);return a("div",{className:"App",children:w("div",{className:"row",children:[a(ue,{toggleFileManager:()=>{p(!r)},playerActive:o,setPlayerActive:i,editorActive:t,setEditorActive:s}),a(ae,{className:t?"":"mobile-hide",setStory:e,showFileManager:r}),a(de,{story:n,className:o?"":"mobile-hide"})]})})}Q.render(a(X.StrictMode,{children:a(pe,{})}),document.getElementById("root"));
