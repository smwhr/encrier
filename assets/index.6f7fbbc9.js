var W=Object.defineProperty,J=Object.defineProperties;var Y=Object.getOwnPropertyDescriptors;var K=Object.getOwnPropertySymbols;var V=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable;var M=(n,e,t)=>e in n?W(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,C=(n,e)=>{for(var t in e||(e={}))V.call(e,t)&&M(n,t,e[t]);if(K)for(var t of K(e))q.call(e,t)&&M(n,t,e[t]);return n},S=(n,e)=>J(n,Y(e));var I=(n,e,t)=>(M(n,typeof e!="symbol"?e+"":e,t),t);import{C as A,j as r,a as N,u as z,r as d,i as Q,R as X,b as Z}from"./vendor.f43ac392.js";const ee=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerpolicy&&(s.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?s.credentials="include":o.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=t(o);fetch(o.href,s)}};ee();class _ extends Error{}class te{constructor(e){I(this,"ResolveInkFilename",e=>{if(Object.keys(this.fileHierarchy).includes(`inmemory://model/${e}`))return e;throw new _(`RUNTIME ERROR: '${e}' line 0: Cannot locate file ${e}.`)});I(this,"LoadInkFileContents",e=>{if(Object.keys(this.fileHierarchy).includes(`inmemory://model/${e}`))return this.fileHierarchy[`inmemory://model/${e}`];throw new _(`RUNTIME ERROR: '${e}' line 0: Cannot open file ${e}.`)});I(this,"update",(e,t)=>(this.fileHierarchy[e]=t,this));I(this,"delete",e=>(delete this.fileHierarchy[e],this));this.fileHierarchy=e}}const ne=(n,e)=>{const t=[],i=(a,x)=>{var m=/^(ERROR|WARNING|RUNTIME ERROR|RUNTIME WARNING|TODO): ('([^']+)' )?line (\d+): (.*)/;let v=a.match(m);if(v){const l=v[1],h=v[3],b=parseInt(v[4]),w=v[5],f=/\n/gi,R=[0];let y=null;for(;y=f.exec(n);)R.push(y.index+1);const E=R[b-1]||0,k={type:l,filename:h,lineNumber:b,index:E,msg:w};t.push(k)}},o=new A.CompilerOptions(null,[],!1,i,e.fileHandler),s=new A.Compiler(n,o);try{const a=s.Compile(),x=s.parsedStory;return{story:a,parsedStory:x,parseErrors:t}}catch(a){return a instanceof _&&i(a.message),{story:void 0,parsedStory:void 0,parseErrors:t}}},oe=n=>n.GetType()=="Knot",ie=n=>[{label:"choice",kind:n.languages.CompletionItemKind.Snippet,insertText:"* ${1:text}",insertTextRules:n.languages.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Simple choice"},{label:"labeled-choice",kind:n.languages.CompletionItemKind.Snippet,insertText:"*(${2:label}) ${1:text}",insertTextRules:n.languages.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Labeled choice"}],re=n=>{const{toggleFileManager:e}=n;return r("div",{className:"split-view-view visible left-bar",style:{left:"0px",width:"48px",height:"100%"},children:r("div",{className:"monaco-action-bar vertical",children:N("ul",{className:"actions-container",role:"toolbar","aria-label":"Active View Switcher",children:[N("li",{className:"action-item icon",role:"tab",children:[r("a",{className:"action-label codicon codicon-explorer-view-icon",style:{color:"rgb(248, 248, 242)"},onClick:e}),r("div",{className:"active-item-indicator"})]}),N("li",{className:"action-item icon checked",role:"tab",children:[r("a",{className:"action-label codicon codicon-edit-icon",style:{color:"rgb(248, 248, 242)"}}),r("div",{className:"active-item-indicator"})]}),N("li",{className:"action-item icon checked",role:"tab",children:[r("a",{className:"action-label codicon codicon-play-icon",style:{color:"rgb(248, 248, 242)"}}),r("div",{className:"active-item-indicator"})]})]})})})},se=n=>{const{visible:e,fileHandler:t}=n,i=Object.keys(t.fileHierarchy).map(o=>o.replace("inmemory://model/",""));return r("div",{className:`split-view-view ${e?"visible":""} files-bar`,style:{left:"48px",width:"120px",height:"100%"},children:r("div",{className:"monaco-list",children:r("div",{className:"monaco-scrollable-element",children:r("div",{className:"monaco-list-rows",children:i.map(o=>r("div",{className:"monaco-list-row",children:r("div",{className:"monaco-tl-row",children:r("div",{className:"monaco-tl-contents",children:r("div",{className:"monaco-icon-label",children:N("div",{className:"monaco-icon-label-container",children:[r("span",{className:"monaco-icon-name-container",children:r("a",{className:"label-name",children:r("span",{children:o})})}),r("span",{className:"monaco-icon-description-container"})]})})})})},o))})})})})},F=function(n,e){const t=document.createElement("a"),i=window.URL.createObjectURL(n);t.href=i,t.download=e,t.click(),window.URL.revokeObjectURL(i)},ce=async function(n="*",e=!1){return new Promise(t=>{const i=document.createElement("input");i.setAttribute("type","file"),i.addEventListener("change",()=>{var o;if(((o=i.files)==null?void 0:o.length)||0>0){const s=i.files[0];ae(s).then(a=>{t({filename:s.name,content:a})})}i.remove()}),i.click()})},ae=async function(n){return new Promise((e,t)=>{const i=new FileReader;i.onerror=t,i.onload=()=>e(i.result),i.readAsText(n)})},le=({setStory:n})=>{const e=`LIST letters = a,b,c
    Once upon a time...
    -(opts)
    + Choice A.
    + Choice B.
    + Choice C.
        ->knot
   
   - They lived happily ever after {opts}.
       -> opts

== knot ==
Another castle
->END
   `,t=z(),i=d.exports.useRef(null),[o,s]=d.exports.useState(e),[a,x]=d.exports.useState(),[m,v]=d.exports.useState(),[l,h]=d.exports.useState(),[b,w]=d.exports.useState([]),[f,R]=d.exports.useState(new te({"inmemory://model/1":e})),[y,E]=d.exports.useState(!1),k=()=>{E(!y)};d.exports.useEffect(()=>{if(t&&i.current&&l){const c=i.current;let u=l.map(p=>({range:new t.Range(p.lineNumber,1,p.lineNumber,1),options:{isWholeLine:!0,glyphMarginClassName:p.type.includes("ERROR")?"errorIcon":p.type.includes("WARNING")?"warningIcon":"infoIcon",linesDecorationsClassName:p.type.includes("ERROR")?"errorLineDecoration":p.type.includes("WARNING")?"warningLineDecoration":"infoLineDecoration",glyphMarginHoverMessage:{value:p.msg}}}));w(c.deltaDecorations(b,u))}},[t,i,l]),d.exports.useEffect(()=>{if(t&&m){const c=t.languages.registerFoldingRangeProvider("ink",{provideFoldingRanges:function(){return m.content.filter(u=>u.debugMetadata!==null).map(u=>({start:u.debugMetadata.startLineNumber,end:Math.max(u.debugMetadata.startLineNumber,u.debugMetadata.endLineNumber-1),kind:t.languages.FoldingRangeKind.Region}))}});return()=>{c.dispose()}}},[t,m]),d.exports.useEffect(()=>{if(t&&m){const c=t.languages.registerCompletionItemProvider("ink",{provideCompletionItems:function(){const u=m.content.filter(g=>g.debugMetadata!==null).filter(oe).map(g=>({label:g.name,kind:t.languages.CompletionItemKind.Text,insertText:`-> ${g.name}`})),p=ie(t);return{suggestions:u.concat(p)}}});return()=>{c.dispose()}}},[t,m]),d.exports.useEffect(()=>{const{story:c,parsedStory:u,parseErrors:p}=ne(o,{fileHandler:f});c&&(n(c),x(c)),v(u),h(p)},[o,t,i]);const P=c=>{c&&s(c)},j=(c,u)=>()=>{ce().then(({filename:p,content:g})=>{console.log(g);var $=u.editor.createModel(g,"ink",`inmemory://model/${p}`);const T=c.getModel();T.dispose(),c.setModel($),f.delete(`${T.uri}`).update(`${$.uri}`,o),s(g),R(f)})},U=()=>{if(a){const c=new Blob([a.ToJson()],{type:"application/json"});F(c,"main.ink.json")}else alert("There are errors to fix first.")},B=()=>{if(o){const c=new Blob([o],{type:"text/plain"});F(c,"main.ink")}else alert("File is empty")};d.exports.useEffect(()=>{if(!i.current||!t)return;const c=i.current,u=c.addAction({id:"save_json",label:"Save as JSON",keybindings:[t.KeyMod.CtrlCmd|t.KeyMod.Shift|t.KeyCode.KEY_S],run:U}),p=c.addAction({id:"save_story",label:"Save story",keybindings:[t.KeyMod.CtrlCmd|t.KeyCode.KEY_S],run:B}),g=c.addAction({id:"open_story",label:"Open story (ink)",keybindings:[t.KeyMod.CtrlCmd|t.KeyMod.Shift|t.KeyCode.KEY_O,t.KeyMod.CtrlCmd|t.KeyCode.KEY_O],run:j(c,t)});return()=>{u.dispose(),p.dispose(),g.dispose()}},[i,a,o]);const G=(c,u)=>{i.current=c,u.languages.register({id:"ink"})},L=48+(y?120:0);return r("div",{className:"monaco-split-view2",style:{padding:0},children:r("div",{className:"monaco-scrollable-element",children:N("div",{className:"split-view-container",children:[r(re,{toggleFileManager:k}),r(se,{visible:y,fileHandler:f}),r("div",{className:"split-view-view visible",style:{left:`${L}px`,width:`calc( 100% - ${L}px )`,height:"100%"},children:r(Q,{className:"editor",theme:"vs-dark",height:"100%",width:"auto",defaultValue:o,language:"ink",onChange:P,onMount:G,options:{glyphMargin:!0}})})]})})})},de=(n,e)=>({text:n,index:e,delay:0}),H=(n,e=[])=>({text:n,classList:e,delay:0}),D={texts:[],choices:[]};function ue(n,e){switch(e.type){case"reset":return D;case"add_text":return S(C({},n),{texts:n.texts.concat(e.payload)});case"delay_text":const{index:t,delay:i}=e.payload,o=n.texts;return o[t].delay=i,S(C({},n),{texts:o});case"add_choice":return S(C({},n),{choices:n.choices.concat(e.payload)});case"delay_choice":const{index:s,delay:a}=e.payload,x=n.choices;return x[s].delay=a,S(C({},n),{choices:x});case"clear_choices":return S(C({},n),{choices:[]});default:throw new Error}}const pe=({story:n})=>{const[e,t]=d.exports.useReducer(ue,D),[i,o]=d.exports.useState([]),s=d.exports.useRef(e.texts),a=d.exports.useRef(null);if(d.exports.useLayoutEffect(()=>{if(n!==null){for(let l of i)try{O(n,t,l)}catch{console.log(`Could not choose ${l}`),o(i.slice(0,i.indexOf(l)));break}return O(n,t),()=>{t({type:"reset"})}}},[n]),d.exports.useLayoutEffect(()=>{if(a.current===null)return;const l=s.current,h=e.texts;let b=0;for(let f of h)if(l.indexOf(f)===-1){const y=h.indexOf(f),E=b*200;t({type:"delay_text",payload:{index:y,delay:E}}),b++}for(let f of m){if(f.delay>0)continue;const R=m.indexOf(f),y=b*200;t({type:"delay_choice",payload:{index:R,delay:y}}),b++}s.current=h;const w=a.current.querySelector("p:last-child");w&&w.scrollIntoView({behavior:"smooth",block:"end",inline:"nearest"})},[n,e.texts,e.choices]),n===null)return null;const{texts:x,choices:m}=e,v=l=>h=>{h.preventDefault(),t({type:"clear_choices"}),o(i.concat(l)),n.ChooseChoiceIndex(l),O(n,t)};return N("div",{className:"container",ref:a,children:[x.map((l,h)=>r("p",{style:{animationDelay:l.delay+200+"ms"},children:l.text},h)),m.length>0&&m.map(l=>r("p",{className:"choice",style:{animationDelay:l.delay+200+"ms"},children:r("a",{href:"#",onClick:v(l.index),children:l.text})},`choice-${i.length}-${l.index}`)),r("p",{})]})};function O(n,e,t){for(;n.canContinue;){var i=n.Continue(),o=n.currentTags;e({type:"add_text",payload:H(i)}),o&&o.length>0&&e({type:"add_text",payload:H(o.map(s=>`#${s}`).join(" "),["tags"])})}if(t!==void 0){n.ChooseChoiceIndex(t);return}n.currentChoices.forEach(function(s,a){e({type:"add_choice",payload:de(s.text,s.index)})})}function me(){d.exports.useState(0);const[n,e]=d.exports.useState(null);return r("div",{className:"App",children:N("div",{className:"row",children:[r(le,{setStory:e}),r(pe,{story:n})]})})}X.render(r(Z.StrictMode,{children:r(me,{})}),document.getElementById("root"));
