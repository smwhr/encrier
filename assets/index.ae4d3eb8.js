var G=Object.defineProperty,J=Object.defineProperties;var Y=Object.getOwnPropertyDescriptors;var T=Object.getOwnPropertySymbols;var V=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable;var F=(t,e,o)=>e in t?G(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o,S=(t,e)=>{for(var o in e||(e={}))V.call(e,o)&&F(t,o,e[o]);if(T)for(var o of T(e))q.call(e,o)&&F(t,o,e[o]);return t},R=(t,e)=>J(t,Y(e));var I=(t,e,o)=>(F(t,typeof e!="symbol"?e+"":e,o),o);import{C as L,r as d,j as c,a as x,u as z,i as Q,R as X,b as Z}from"./vendor.6c7b1072.js";const ee=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function o(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerpolicy&&(i.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?i.credentials="include":n.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(n){if(n.ep)return;n.ep=!0;const i=o(n);fetch(n.href,i)}};ee();class K extends Error{}class te{constructor(e){I(this,"_activeFile","file:///default.ink");I(this,"ResolveInkFilename",e=>{if(Object.keys(this.fileHierarchy).includes(`file:///${e}`))return e;throw new K(`RUNTIME ERROR: '${e}' line 0: Cannot locate file ${e}.`)});I(this,"LoadInkFileContents",e=>{if(Object.keys(this.fileHierarchy).includes(`file:///${e}`))return this.fileHierarchy[`file:///${e}`];throw new K(`RUNTIME ERROR: '${e}' line 0: Cannot open file ${e}.`)});I(this,"update",(e,o)=>(this.fileHierarchy[e]=o,this));I(this,"delete",e=>(delete this.fileHierarchy[e],this));I(this,"active",e=>e===void 0?this._activeFile:(this._activeFile=e,this));this.fileHierarchy=e}}const ne=(t,e)=>{const o=[],r=(s,p)=>{var y=/^(ERROR|WARNING|RUNTIME ERROR|RUNTIME WARNING|TODO): ('([^']+)' )?line (\d+): (.*)/;let m=s.match(y);if(m){const g=m[1],E=m[3],b=parseInt(m[4]),M=m[5],N=/\n/gi,k=[0];let l=null;for(;l=N.exec(t);)k.push(l.index+1);const f=k[b-1]||0,w={type:g,filename:E,lineNumber:b,index:f,msg:M};o.push(w)}},n=new L.CompilerOptions(null,[],!1,r,e.fileHandler),i=new L.Compiler(t,n);try{const s=i.Compile(),p=i.parsedStory;return{story:s,parsedStory:p,parseErrors:o}}catch(s){return s instanceof K&&r(s.message),{story:void 0,parsedStory:void 0,parseErrors:o}}},oe=t=>t.GetType()=="Knot",ie=t=>[{label:"choice",kind:t.languages.CompletionItemKind.Snippet,insertText:"* ${1:text}",insertTextRules:t.languages.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Simple choice"},{label:"labeled-choice",kind:t.languages.CompletionItemKind.Snippet,insertText:"*(${2:label}) ${1:text}",insertTextRules:t.languages.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Labeled choice"}],se=t=>{const{visible:e,fileHandler:o,active:r,setActiveFile:n}=t,i=Object.keys(o.fileHierarchy);return d.exports.useEffect(()=>{console.log("rerender file list")},[i,r]),c("div",{className:`split-view-view ${e?"visible":""} files-bar`,style:{left:"48px",width:"120px",height:"100%"},children:c("div",{className:"monaco-list",children:c("div",{className:"monaco-scrollable-element",children:c("div",{className:"monaco-list-rows",children:i.map(s=>c("div",{className:`monaco-list-row ${s===r?"highlight":""}`,children:c("div",{className:"monaco-tl-row",children:c("div",{className:"monaco-tl-contents",children:c("div",{className:"monaco-icon-label",children:x("div",{className:"monaco-icon-label-container",children:[c("span",{className:"monaco-icon-name-container",children:c("a",{className:"label-name ${}",onClick:n(s),children:c("span",{children:s.replace("file:///","")})})}),c("span",{className:"monaco-icon-description-container"})]})})})})},s))})})})})},H=function(t,e){const o=document.createElement("a"),r=window.URL.createObjectURL(t);o.href=r,o.download=e,o.click(),window.URL.revokeObjectURL(r)},re=async function(t="*",e=!1){return new Promise(o=>{const r=document.createElement("input");r.setAttribute("type","file"),r.addEventListener("change",()=>{var n;if(((n=r.files)==null?void 0:n.length)||0>0){const i=r.files[0];ce(i).then(s=>{o({filename:i.name,content:s})})}r.remove()}),r.click()})},ce=async function(t){return new Promise((e,o)=>{const r=new FileReader;r.onerror=o,r.onload=()=>e(r.result),r.readAsText(t)})},le=({setStory:t,className:e,showFileManager:o})=>{const r=`LIST letters = a,b,c
    Once upon a time...
    -(opts)
    + Choice A.
    + Choice B.
    + Choice C.
        ->knot
   
   - They lived happily ever after {opts}.
       -> opts

== knot ==
Another castle
->END
   `,n=z(),i=d.exports.useRef(null),[s,p]=d.exports.useState(r),[y,m]=d.exports.useState(),[g,E]=d.exports.useState(),[b,M]=d.exports.useState(),[N,k]=d.exports.useState([]),[l,f]=d.exports.useState(new te({"file:///default.ink":r}));d.exports.useEffect(()=>{if(n&&i.current&&b){const a=i.current;let u=b.map(h=>({range:new n.Range(h.lineNumber,1,h.lineNumber,1),options:{isWholeLine:!0,glyphMarginClassName:h.type.includes("ERROR")?"errorIcon":h.type.includes("WARNING")?"warningIcon":"infoIcon",glyphMarginHoverMessage:{value:h.msg}}}));k(a.deltaDecorations(N,u))}},[n,i,b]),d.exports.useEffect(()=>{if(n&&g){const a=n.languages.registerFoldingRangeProvider("ink",{provideFoldingRanges:function(){return g.content.filter(u=>u.debugMetadata!==null).map(u=>({start:u.debugMetadata.startLineNumber,end:Math.max(u.debugMetadata.startLineNumber,u.debugMetadata.endLineNumber-1),kind:n.languages.FoldingRangeKind.Region}))}});return()=>{a.dispose()}}},[n,g]),d.exports.useEffect(()=>{if(n&&g){const a=n.languages.registerCompletionItemProvider("ink",{provideCompletionItems:function(){const u=g.content.filter(v=>v.debugMetadata!==null).filter(oe).map(v=>({label:v.name,kind:n.languages.CompletionItemKind.Text,insertText:`-> ${v.name}`})),h=ie(n);return{suggestions:u.concat(h)}}});return()=>{a.dispose()}}},[n,g]),d.exports.useEffect(()=>{const{story:a,parsedStory:u,parseErrors:h}=ne(s,{fileHandler:l});a&&(t(a),m(a)),E(u),M(h)},[s,n,i]);const w=a=>{a&&p(a)},C=(a,u)=>()=>{re().then(({filename:h,content:v})=>{var $=u.editor.createModel(v,"ink",`file:///${h}`);a.getModel().dispose(),a.setModel($),l.update(`${$.uri}`,s).active(`${$.uri}`),p(v),f(l)})},O=a=>()=>{if(y){const u=new Blob([y.ToJson()],{type:"application/json"}),h=a.getModel();H(u,`${h.uri}.json`.replace("file:///",""))}else alert("There are errors to fix first.")},A=()=>{if(s){const a=new Blob([s],{type:"text/plain"});H(a,"main.ink")}else alert("File is empty")};d.exports.useEffect(()=>{if(!i.current||!n)return;const a=i.current,u=a.addAction({id:"save_json",label:"Save as JSON",keybindings:[n.KeyMod.CtrlCmd|n.KeyMod.Shift|n.KeyCode.KEY_S],run:O(a)}),h=a.addAction({id:"save_story",label:"Save story",keybindings:[n.KeyMod.CtrlCmd|n.KeyCode.KEY_S],run:A}),v=a.addAction({id:"open_story",label:"Open story (ink)",keybindings:[n.KeyMod.CtrlCmd|n.KeyMod.Shift|n.KeyCode.KEY_O,n.KeyMod.CtrlCmd|n.KeyCode.KEY_O],run:C(a,n)});return()=>{u.dispose(),h.dispose(),v.dispose()}},[i,y,s]);const U=(a,u)=>{i.current=a,u.languages.register({id:"ink"})},B=a=>u=>()=>{console.log(a,u),a!==null&&(l.active(u),f(l))},W=l.active();return x("div",{className:`editor-wrapper ${e} ${o?"with-filemanager":""}`,children:[c(se,{visible:o,fileHandler:l,active:W,setActiveFile:B(i.current)}),c(Q,{className:"editor",theme:"vs-dark",height:"100%",width:"100%",defaultValue:s,language:"ink",path:"default.ink",onChange:w,onMount:U,options:{glyphMargin:!0,lineDecorationsWidth:2,lineNumbers:"off"}})]})},ae=(t,e)=>({text:t,index:e,delay:null}),P=(t,e=[])=>({text:t,classList:e,delay:null});function j(t,e){return R(S({},t),{delay:e})}const D={texts:[],choices:[],delayIndex:1};function de(t,e){switch(e.type){case"reset":return D;case"add_text":return R(S({},t),{texts:t.texts.concat(e.payload)});case"delay_text":const{index:o}=e.payload,r=t.texts,n=r[o],i=n.delay===null?t.delayIndex:n.delay;return r[o].delay=i,i===0&&r[o].classList.push("no-animation"),R(S({},t),{texts:r,delayIndex:i===0?1:t.delayIndex+1});case"add_choice":return R(S({},t),{choices:t.choices.concat(e.payload)});case"delay_choice":const{index:s}=e.payload,p=t.choices,y=p[s],m=y.delay===null?t.delayIndex:y.delay;return p[s].delay=m,R(S({},t),{choices:p,delayIndex:t.delayIndex+1});case"clear_choices":return R(S({},t),{choices:[],delayIndex:1});default:throw new Error}}const ue=({story:t,className:e})=>{const[o,r]=d.exports.useState(t),[n,i]=d.exports.useReducer(de,D),[s,p]=d.exports.useState([]),y=d.exports.useRef(n.texts),m=d.exports.useRef(null),g=()=>{if(o===null)return;const l=s.slice(0,-1);o.ResetState(),p(l),r(null),setTimeout(()=>{r(o)},0)},E=()=>{const l=window.prompt("Knot name ?");if(l!==null)return b(l)},b=l=>{o!==null&&(i({type:"clear_choices"}),o.ChoosePathString(l),_(o,i))};if(d.exports.useEffect(()=>{r(t)},[t]),d.exports.useLayoutEffect(()=>{if(o!==null){for(let l of s)try{_(o,i,l)}catch{console.log(`Could not choose ${l}`),p(s.slice(0,s.indexOf(l)));break}return _(o,i,null),()=>{i({type:"reset"})}}},[o]),d.exports.useLayoutEffect(()=>{if(m.current===null)return;const l=y.current,f=n.texts;for(let C of f)if(l.indexOf(C)===-1){const A=f.indexOf(C);i({type:"delay_text",payload:{index:A}})}for(let C of N){if(C.delay!==null)continue;const O=N.indexOf(C);i({type:"delay_choice",payload:{index:O}})}y.current=f;const w=m.current.querySelector("p:last-child");w&&w.scrollIntoView({behavior:"smooth",block:"end",inline:"nearest"})},[o,n.texts,n.choices]),o===null)return null;const{texts:M,choices:N}=n,k=l=>f=>{f.preventDefault(),i({type:"clear_choices"});const w=[...s,l];p(w),o.ChooseChoiceIndex(l),_(o,i)};return x("div",{className:"player-wrapper",children:[c("div",{className:"toolbar ",children:x("div",{className:"actions-container",children:[c("div",{className:"action-item icon",children:c("a",{className:"action-label codicon codicon-debug-step-into",style:{color:"rgb(248, 248, 242)"},onClick:E})}),c("div",{className:"action-item icon",children:c("a",{className:"action-label codicon codicon-debug-step-back",style:{color:"rgb(248, 248, 242)"},onClick:g})})]})}),x("div",{className:`container ${e}`,ref:m,children:[M.map((l,f)=>c("p",{className:l.classList.join(" "),style:{animationDelay:l.delay*200+"ms"},children:l.text},f)),N.length>0&&N.map(l=>c("p",{className:"choice",style:{animationDelay:l.delay*200+"ms"},children:c("a",{href:"#",onClick:k(l.index),children:l.text})},`choice-${s.length}-${l.index}`)),c("p",{})]})]})};function _(t,e,o){const r=o!==void 0?0:null;for(;t.canContinue;){var n=t.Continue(),i=t.currentTags;e({type:"add_text",payload:j(P(n),r)}),i&&i.length>0&&e({type:"add_text",payload:j(P(i.map(s=>`#${s}`).join(" "),["tags"]),r)})}if(o!=null){t.ChooseChoiceIndex(o);return}t.currentChoices.forEach(function(s,p){e({type:"add_choice",payload:ae(s.text,s.index)})})}const pe=({toggleFileManager:t,playerActive:e,setPlayerActive:o,editorActive:r,setEditorActive:n})=>c("div",{className:"left-bar",children:c("div",{className:"monaco-action-bar vertical",children:x("ul",{className:"actions-container",role:"toolbar","aria-label":"Active View Switcher",children:[x("li",{className:"action-item icon checked mobile-show",role:"tab",children:[c("a",{className:"action-label codicon codicon-edit-icon",style:{color:"rgb(248, 248, 242)"},onClick:()=>{o(!1),n(!0)}}),c("div",{className:"active-item-indicator"})]}),r&&x("li",{className:"action-item icon",role:"tab",children:[c("a",{className:"action-label codicon codicon-explorer-view-icon",style:{color:"rgb(248, 248, 242)"},onClick:t}),c("div",{className:"active-item-indicator"})]}),x("li",{className:"action-item icon checked mobile-show",role:"tab",children:[c("a",{className:"action-label codicon codicon-play-icon",style:{color:"rgb(248, 248, 242)"},onClick:()=>{o(!0),n(!1)}}),c("div",{className:"active-item-indicator"})]})]})})});function he(){const[t,e]=d.exports.useState(null),[o,r]=d.exports.useState(!1),[n,i]=d.exports.useState(!0),[s,p]=d.exports.useState(!1);return c("div",{className:"App",children:x("div",{className:"row",children:[c(pe,{toggleFileManager:()=>{p(!s)},playerActive:o,setPlayerActive:r,editorActive:n,setEditorActive:i}),c(le,{className:n?"":"mobile-hide",setStory:e,showFileManager:s}),c(ue,{story:t,className:o?"":"mobile-hide"})]})})}X.render(c(Z.StrictMode,{children:c(he,{})}),document.getElementById("root"));
