var W=Object.defineProperty,G=Object.defineProperties;var J=Object.getOwnPropertyDescriptors;var K=Object.getOwnPropertySymbols;var Y=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable;var O=(n,e,o)=>e in n?W(n,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[e]=o,S=(n,e)=>{for(var o in e||(e={}))Y.call(e,o)&&O(n,o,e[o]);if(K)for(var o of K(e))V.call(e,o)&&O(n,o,e[o]);return n},C=(n,e)=>G(n,J(e));var E=(n,e,o)=>(O(n,typeof e!="symbol"?e+"":e,o),o);import{C as L,j as c,a as w,u as q,r as l,i as z,R as Q,b as X}from"./vendor.f43ac392.js";const Z=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))r(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function o(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerpolicy&&(s.referrerPolicy=t.referrerpolicy),t.crossorigin==="use-credentials"?s.credentials="include":t.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(t){if(t.ep)return;t.ep=!0;const s=o(t);fetch(t.href,s)}};Z();class T extends Error{}class ee{constructor(e){E(this,"ResolveInkFilename",e=>{if(Object.keys(this.fileHierarchy).includes(`inmemory://model/${e}`))return e;throw new T(`RUNTIME ERROR: '${e}' line 0: Cannot locate file ${e}.`)});E(this,"LoadInkFileContents",e=>{if(Object.keys(this.fileHierarchy).includes(`inmemory://model/${e}`))return this.fileHierarchy[`inmemory://model/${e}`];throw new T(`RUNTIME ERROR: '${e}' line 0: Cannot open file ${e}.`)});E(this,"update",(e,o)=>(this.fileHierarchy[e]=o,this));E(this,"delete",e=>(delete this.fileHierarchy[e],this));this.fileHierarchy=e}}const te=(n,e)=>{const o=[],r=(i,p)=>{var f=/^(ERROR|WARNING|RUNTIME ERROR|RUNTIME WARNING|TODO): ('([^']+)' )?line (\d+): (.*)/;let m=i.match(f);if(m){const b=m[1],I=m[3],x=parseInt(m[4]),k=m[5],d=/\n/gi,y=[0];let g=null;for(;g=d.exec(n);)y.push(g.index+1);const N=y[x-1]||0,R={type:b,filename:I,lineNumber:x,index:N,msg:k};o.push(R)}},t=new L.CompilerOptions(null,[],!1,r,e.fileHandler),s=new L.Compiler(n,t);try{const i=s.Compile(),p=s.parsedStory;return{story:i,parsedStory:p,parseErrors:o}}catch(i){return i instanceof T&&r(i.message),{story:void 0,parsedStory:void 0,parseErrors:o}}},ne=n=>n.GetType()=="Knot",oe=n=>[{label:"choice",kind:n.languages.CompletionItemKind.Snippet,insertText:"* ${1:text}",insertTextRules:n.languages.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Simple choice"},{label:"labeled-choice",kind:n.languages.CompletionItemKind.Snippet,insertText:"*(${2:label}) ${1:text}",insertTextRules:n.languages.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Labeled choice"}],se=n=>{const{visible:e,fileHandler:o}=n,r=Object.keys(o.fileHierarchy).map(t=>t.replace("inmemory://model/",""));return c("div",{className:`split-view-view ${e?"visible":""} files-bar`,style:{left:"48px",width:"120px",height:"100%"},children:c("div",{className:"monaco-list",children:c("div",{className:"monaco-scrollable-element",children:c("div",{className:"monaco-list-rows",children:r.map(t=>c("div",{className:"monaco-list-row",children:c("div",{className:"monaco-tl-row",children:c("div",{className:"monaco-tl-contents",children:c("div",{className:"monaco-icon-label",children:w("div",{className:"monaco-icon-label-container",children:[c("span",{className:"monaco-icon-name-container",children:c("a",{className:"label-name",children:c("span",{children:t})})}),c("span",{className:"monaco-icon-description-container"})]})})})})},t))})})})})},H=function(n,e){const o=document.createElement("a"),r=window.URL.createObjectURL(n);o.href=r,o.download=e,o.click(),window.URL.revokeObjectURL(r)},re=async function(n="*",e=!1){return new Promise(o=>{const r=document.createElement("input");r.setAttribute("type","file"),r.addEventListener("change",()=>{var t;if(((t=r.files)==null?void 0:t.length)||0>0){const s=r.files[0];ie(s).then(i=>{o({filename:s.name,content:i})})}r.remove()}),r.click()})},ie=async function(n){return new Promise((e,o)=>{const r=new FileReader;r.onerror=o,r.onload=()=>e(r.result),r.readAsText(n)})},ce=({setStory:n,className:e,showFileManager:o})=>{const r=`LIST letters = a,b,c
    Once upon a time...
    -(opts)
    + Choice A.
    + Choice B.
    + Choice C.
        ->knot
   
   - They lived happily ever after {opts}.
       -> opts

== knot ==
Another castle
->END
   `,t=q(),s=l.exports.useRef(null),[i,p]=l.exports.useState(r),[f,m]=l.exports.useState(),[b,I]=l.exports.useState(),[x,k]=l.exports.useState(),[d,y]=l.exports.useState([]),[g,N]=l.exports.useState(new ee({"inmemory://model/1":r}));l.exports.useEffect(()=>{if(t&&s.current&&x){const a=s.current;let u=x.map(h=>({range:new t.Range(h.lineNumber,1,h.lineNumber,1),options:{isWholeLine:!0,glyphMarginClassName:h.type.includes("ERROR")?"errorIcon":h.type.includes("WARNING")?"warningIcon":"infoIcon",glyphMarginHoverMessage:{value:h.msg}}}));y(a.deltaDecorations(d,u))}},[t,s,x]),l.exports.useEffect(()=>{if(t&&b){const a=t.languages.registerFoldingRangeProvider("ink",{provideFoldingRanges:function(){return b.content.filter(u=>u.debugMetadata!==null).map(u=>({start:u.debugMetadata.startLineNumber,end:Math.max(u.debugMetadata.startLineNumber,u.debugMetadata.endLineNumber-1),kind:t.languages.FoldingRangeKind.Region}))}});return()=>{a.dispose()}}},[t,b]),l.exports.useEffect(()=>{if(t&&b){const a=t.languages.registerCompletionItemProvider("ink",{provideCompletionItems:function(){const u=b.content.filter(v=>v.debugMetadata!==null).filter(ne).map(v=>({label:v.name,kind:t.languages.CompletionItemKind.Text,insertText:`-> ${v.name}`})),h=oe(t);return{suggestions:u.concat(h)}}});return()=>{a.dispose()}}},[t,b]),l.exports.useEffect(()=>{const{story:a,parsedStory:u,parseErrors:h}=te(i,{fileHandler:g});a&&(n(a),m(a)),I(u),k(h)},[i,t,s]);const R=a=>{a&&p(a)},M=(a,u)=>()=>{re().then(({filename:h,content:v})=>{console.log(v);var _=u.editor.createModel(v,"ink",`inmemory://model/${h}`);const $=a.getModel();$.dispose(),a.setModel(_),g.delete(`${$.uri}`).update(`${_.uri}`,i),p(v),N(g)})},D=()=>{if(f){const a=new Blob([f.ToJson()],{type:"application/json"});H(a,"main.ink.json")}else alert("There are errors to fix first.")},U=()=>{if(i){const a=new Blob([i],{type:"text/plain"});H(a,"main.ink")}else alert("File is empty")};l.exports.useEffect(()=>{if(!s.current||!t)return;const a=s.current,u=a.addAction({id:"save_json",label:"Save as JSON",keybindings:[t.KeyMod.CtrlCmd|t.KeyMod.Shift|t.KeyCode.KEY_S],run:D}),h=a.addAction({id:"save_story",label:"Save story",keybindings:[t.KeyMod.CtrlCmd|t.KeyCode.KEY_S],run:U}),v=a.addAction({id:"open_story",label:"Open story (ink)",keybindings:[t.KeyMod.CtrlCmd|t.KeyMod.Shift|t.KeyCode.KEY_O,t.KeyMod.CtrlCmd|t.KeyCode.KEY_O],run:M(a,t)});return()=>{u.dispose(),h.dispose(),v.dispose()}},[s,f,i]);const B=(a,u)=>{s.current=a,u.languages.register({id:"ink"})};return w("div",{className:`editor-wrapper ${e} ${o?"with-filemanager":""}`,children:[c(se,{visible:o,fileHandler:g}),c(z,{className:"editor",theme:"vs-dark",height:"100%",width:"100%",defaultValue:i,language:"ink",onChange:R,onMount:B,options:{glyphMargin:!0,lineDecorationsWidth:2,lineNumbers:"off"}})]})},ae=(n,e)=>({text:n,index:e,delay:null}),F=(n,e=[])=>({text:n,classList:e,delay:null});function P(n,e){return C(S({},n),{delay:e})}const j={texts:[],choices:[],delayIndex:1};function le(n,e){switch(e.type){case"reset":return j;case"add_text":return C(S({},n),{texts:n.texts.concat(e.payload)});case"delay_text":const{index:o}=e.payload,r=n.texts,t=r[o],s=t.delay===null?n.delayIndex:t.delay;return r[o].delay=s,s===0&&r[o].classList.push("no-animation"),C(S({},n),{texts:r,delayIndex:s===0?1:n.delayIndex+1});case"add_choice":return C(S({},n),{choices:n.choices.concat(e.payload)});case"delay_choice":const{index:i}=e.payload,p=n.choices,f=p[i],m=f.delay===null?n.delayIndex:f.delay;return p[i].delay=m,C(S({},n),{choices:p,delayIndex:n.delayIndex+1});case"clear_choices":return C(S({},n),{choices:[],delayIndex:1});default:throw new Error}}const de=({story:n,className:e})=>{const[o,r]=l.exports.useState(n),[t,s]=l.exports.useReducer(le,j),[i,p]=l.exports.useState([]),f=l.exports.useRef(t.texts),m=l.exports.useRef(null),b=()=>{if(o===null)return;const d=i.slice(0,-1);o.ResetState(),p(d),r(null),setTimeout(()=>{r(o)},0)};if(l.exports.useEffect(()=>{r(n)},[n]),l.exports.useLayoutEffect(()=>{if(o!==null){for(let d of i)try{A(o,s,d)}catch{console.log(`Could not choose ${d}`),p(i.slice(0,i.indexOf(d)));break}return A(o,s,null),()=>{s({type:"reset"})}}},[o]),l.exports.useLayoutEffect(()=>{if(m.current===null)return;const d=f.current,y=t.texts;for(let N of y)if(d.indexOf(N)===-1){const M=y.indexOf(N);s({type:"delay_text",payload:{index:M}})}for(let N of x){if(N.delay!==null)continue;const R=x.indexOf(N);s({type:"delay_choice",payload:{index:R}})}f.current=y;const g=m.current.querySelector("p:last-child");g&&g.scrollIntoView({behavior:"smooth",block:"end",inline:"nearest"})},[o,t.texts,t.choices]),o===null)return null;const{texts:I,choices:x}=t,k=d=>y=>{y.preventDefault(),s({type:"clear_choices"});const g=[...i,d];p(g),o.ChooseChoiceIndex(d),A(o,s)};return w("div",{className:"player-wrapper",children:[c("div",{className:"toolbar ",children:c("div",{className:"actions-container",children:c("div",{className:"action-item icon",children:c("a",{className:"action-label codicon codicon-debug-step-back",style:{color:"rgb(248, 248, 242)"},onClick:b})})})}),w("div",{className:`container ${e}`,ref:m,children:[I.map((d,y)=>c("p",{className:d.classList.join(" "),style:{animationDelay:d.delay*200+"ms"},children:d.text},y)),x.length>0&&x.map(d=>c("p",{className:"choice",style:{animationDelay:d.delay*200+"ms"},children:c("a",{href:"#",onClick:k(d.index),children:d.text})},`choice-${i.length}-${d.index}`)),c("p",{})]})]})};function A(n,e,o){const r=o!==void 0?0:null;for(;n.canContinue;){var t=n.Continue(),s=n.currentTags;e({type:"add_text",payload:P(F(t),r)}),s&&s.length>0&&e({type:"add_text",payload:P(F(s.map(i=>`#${i}`).join(" "),["tags"]),r)})}if(o!=null){n.ChooseChoiceIndex(o);return}n.currentChoices.forEach(function(i,p){e({type:"add_choice",payload:ae(i.text,i.index)})})}const ue=({toggleFileManager:n,playerActive:e,setPlayerActive:o,editorActive:r,setEditorActive:t})=>c("div",{className:"left-bar",children:c("div",{className:"monaco-action-bar vertical",children:w("ul",{className:"actions-container",role:"toolbar","aria-label":"Active View Switcher",children:[w("li",{className:"action-item icon checked mobile-show",role:"tab",children:[c("a",{className:"action-label codicon codicon-edit-icon",style:{color:"rgb(248, 248, 242)"},onClick:()=>{o(!1),t(!0)}}),c("div",{className:"active-item-indicator"})]}),r&&w("li",{className:"action-item icon",role:"tab",children:[c("a",{className:"action-label codicon codicon-explorer-view-icon",style:{color:"rgb(248, 248, 242)"},onClick:n}),c("div",{className:"active-item-indicator"})]}),w("li",{className:"action-item icon checked mobile-show",role:"tab",children:[c("a",{className:"action-label codicon codicon-play-icon",style:{color:"rgb(248, 248, 242)"},onClick:()=>{o(!0),t(!1)}}),c("div",{className:"active-item-indicator"})]})]})})});function pe(){const[n,e]=l.exports.useState(null),[o,r]=l.exports.useState(!1),[t,s]=l.exports.useState(!0),[i,p]=l.exports.useState(!1);return c("div",{className:"App",children:w("div",{className:"row",children:[c(ue,{toggleFileManager:()=>{p(!i)},playerActive:o,setPlayerActive:r,editorActive:t,setEditorActive:s}),c(ce,{className:t?"":"mobile-hide",setStory:e,showFileManager:i}),c(de,{story:n,className:o?"":"mobile-hide"})]})})}Q.render(c(X.StrictMode,{children:c(pe,{})}),document.getElementById("root"));
