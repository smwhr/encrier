var G=Object.defineProperty,J=Object.defineProperties;var Y=Object.getOwnPropertyDescriptors;var F=Object.getOwnPropertySymbols;var V=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable;var A=(t,e,o)=>e in t?G(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o,C=(t,e)=>{for(var o in e||(e={}))V.call(e,o)&&A(t,o,e[o]);if(F)for(var o of F(e))q.call(e,o)&&A(t,o,e[o]);return t},S=(t,e)=>J(t,Y(e));var R=(t,e,o)=>(A(t,typeof e!="symbol"?e+"":e,o),o);import{C as T,r as a,j as c,a as w,u as z,i as Q,R as X,b as Z}from"./vendor.f43ac392.js";const ee=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function o(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerpolicy&&(i.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?i.credentials="include":n.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(n){if(n.ep)return;n.ep=!0;const i=o(n);fetch(n.href,i)}};ee();class $ extends Error{}class te{constructor(e){R(this,"_activeFile","file:///default.ink");R(this,"ResolveInkFilename",e=>{if(Object.keys(this.fileHierarchy).includes(`file:///${e}`))return e;throw new $(`RUNTIME ERROR: '${e}' line 0: Cannot locate file ${e}.`)});R(this,"LoadInkFileContents",e=>{if(Object.keys(this.fileHierarchy).includes(`file:///${e}`))return this.fileHierarchy[`file:///${e}`];throw new $(`RUNTIME ERROR: '${e}' line 0: Cannot open file ${e}.`)});R(this,"update",(e,o)=>(this.fileHierarchy[e]=o,this));R(this,"delete",e=>(delete this.fileHierarchy[e],this));R(this,"active",e=>e===void 0?this._activeFile:(this._activeFile=e,this));this.fileHierarchy=e}}const ne=(t,e)=>{const o=[],r=(s,p)=>{var g=/^(ERROR|WARNING|RUNTIME ERROR|RUNTIME WARNING|TODO): ('([^']+)' )?line (\d+): (.*)/;let m=s.match(g);if(m){const v=m[1],k=m[3],x=parseInt(m[4]),E=m[5],d=/\n/gi,y=[0];let h=null;for(;h=d.exec(t);)y.push(h.index+1);const b=y[x-1]||0,I={type:v,filename:k,lineNumber:x,index:b,msg:E};o.push(I)}},n=new T.CompilerOptions(null,[],!1,r,e.fileHandler),i=new T.Compiler(t,n);try{const s=i.Compile(),p=i.parsedStory;return{story:s,parsedStory:p,parseErrors:o}}catch(s){return s instanceof $&&r(s.message),{story:void 0,parsedStory:void 0,parseErrors:o}}},oe=t=>t.GetType()=="Knot",ie=t=>[{label:"choice",kind:t.languages.CompletionItemKind.Snippet,insertText:"* ${1:text}",insertTextRules:t.languages.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Simple choice"},{label:"labeled-choice",kind:t.languages.CompletionItemKind.Snippet,insertText:"*(${2:label}) ${1:text}",insertTextRules:t.languages.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Labeled choice"}],se=t=>{const{visible:e,fileHandler:o,active:r,setActiveFile:n}=t,i=Object.keys(o.fileHierarchy);return a.exports.useEffect(()=>{console.log("rerender file list")},[i,r]),c("div",{className:`split-view-view ${e?"visible":""} files-bar`,style:{left:"48px",width:"120px",height:"100%"},children:c("div",{className:"monaco-list",children:c("div",{className:"monaco-scrollable-element",children:c("div",{className:"monaco-list-rows",children:i.map(s=>c("div",{className:`monaco-list-row ${s===r?"highlight":""}`,children:c("div",{className:"monaco-tl-row",children:c("div",{className:"monaco-tl-contents",children:c("div",{className:"monaco-icon-label",children:w("div",{className:"monaco-icon-label-container",children:[c("span",{className:"monaco-icon-name-container",children:c("a",{className:"label-name ${}",onClick:n(s),children:c("span",{children:s.replace("file:///","")})})}),c("span",{className:"monaco-icon-description-container"})]})})})})},s))})})})})},K=function(t,e){const o=document.createElement("a"),r=window.URL.createObjectURL(t);o.href=r,o.download=e,o.click(),window.URL.revokeObjectURL(r)},re=async function(t="*",e=!1){return new Promise(o=>{const r=document.createElement("input");r.setAttribute("type","file"),r.addEventListener("change",()=>{var n;if(((n=r.files)==null?void 0:n.length)||0>0){const i=r.files[0];ce(i).then(s=>{o({filename:i.name,content:s})})}r.remove()}),r.click()})},ce=async function(t){return new Promise((e,o)=>{const r=new FileReader;r.onerror=o,r.onload=()=>e(r.result),r.readAsText(t)})},le=({setStory:t,className:e,showFileManager:o})=>{const r=`LIST letters = a,b,c
    Once upon a time...
    -(opts)
    + Choice A.
    + Choice B.
    + Choice C.
        ->knot
   
   - They lived happily ever after {opts}.
       -> opts

== knot ==
Another castle
->END
   `,n=z(),i=a.exports.useRef(null),[s,p]=a.exports.useState(r),[g,m]=a.exports.useState(),[v,k]=a.exports.useState(),[x,E]=a.exports.useState(),[d,y]=a.exports.useState([]),[h,b]=a.exports.useState(new te({"file:///default.ink":r}));a.exports.useEffect(()=>{if(n&&i.current&&x){const l=i.current;let u=x.map(f=>({range:new n.Range(f.lineNumber,1,f.lineNumber,1),options:{isWholeLine:!0,glyphMarginClassName:f.type.includes("ERROR")?"errorIcon":f.type.includes("WARNING")?"warningIcon":"infoIcon",glyphMarginHoverMessage:{value:f.msg}}}));y(l.deltaDecorations(d,u))}},[n,i,x]),a.exports.useEffect(()=>{if(n&&v){const l=n.languages.registerFoldingRangeProvider("ink",{provideFoldingRanges:function(){return v.content.filter(u=>u.debugMetadata!==null).map(u=>({start:u.debugMetadata.startLineNumber,end:Math.max(u.debugMetadata.startLineNumber,u.debugMetadata.endLineNumber-1),kind:n.languages.FoldingRangeKind.Region}))}});return()=>{l.dispose()}}},[n,v]),a.exports.useEffect(()=>{if(n&&v){const l=n.languages.registerCompletionItemProvider("ink",{provideCompletionItems:function(){const u=v.content.filter(N=>N.debugMetadata!==null).filter(oe).map(N=>({label:N.name,kind:n.languages.CompletionItemKind.Text,insertText:`-> ${N.name}`})),f=ie(n);return{suggestions:u.concat(f)}}});return()=>{l.dispose()}}},[n,v]),a.exports.useEffect(()=>{const{story:l,parsedStory:u,parseErrors:f}=ne(s,{fileHandler:h});l&&(t(l),m(l)),k(u),E(f)},[s,n,i]);const I=l=>{l&&p(l)},M=(l,u)=>()=>{re().then(({filename:f,content:N})=>{var O=u.editor.createModel(N,"ink",`file:///${f}`);l.getModel().dispose(),l.setModel(O),h.update(`${O.uri}`,s).active(`${O.uri}`),p(N),b(h)})},j=l=>()=>{if(g){const u=new Blob([g.ToJson()],{type:"application/json"}),f=l.getModel();K(u,`${f.uri}.json`.replace("file:///",""))}else alert("There are errors to fix first.")},D=()=>{if(s){const l=new Blob([s],{type:"text/plain"});K(l,"main.ink")}else alert("File is empty")};a.exports.useEffect(()=>{if(!i.current||!n)return;const l=i.current,u=l.addAction({id:"save_json",label:"Save as JSON",keybindings:[n.KeyMod.CtrlCmd|n.KeyMod.Shift|n.KeyCode.KEY_S],run:j(l)}),f=l.addAction({id:"save_story",label:"Save story",keybindings:[n.KeyMod.CtrlCmd|n.KeyCode.KEY_S],run:D}),N=l.addAction({id:"open_story",label:"Open story (ink)",keybindings:[n.KeyMod.CtrlCmd|n.KeyMod.Shift|n.KeyCode.KEY_O,n.KeyMod.CtrlCmd|n.KeyCode.KEY_O],run:M(l,n)});return()=>{u.dispose(),f.dispose(),N.dispose()}},[i,g,s]);const U=(l,u)=>{i.current=l,u.languages.register({id:"ink"})},B=l=>u=>()=>{console.log(l,u),l!==null&&(h.active(u),b(h))},W=h.active();return w("div",{className:`editor-wrapper ${e} ${o?"with-filemanager":""}`,children:[c(se,{visible:o,fileHandler:h,active:W,setActiveFile:B(i.current)}),c(Q,{className:"editor",theme:"vs-dark",height:"100%",width:"100%",defaultValue:s,language:"ink",path:"default.ink",onChange:I,onMount:U,options:{glyphMargin:!0,lineDecorationsWidth:2,lineNumbers:"off"}})]})},ae=(t,e)=>({text:t,index:e,delay:null}),L=(t,e=[])=>({text:t,classList:e,delay:null});function H(t,e){return S(C({},t),{delay:e})}const P={texts:[],choices:[],delayIndex:1};function de(t,e){switch(e.type){case"reset":return P;case"add_text":return S(C({},t),{texts:t.texts.concat(e.payload)});case"delay_text":const{index:o}=e.payload,r=t.texts,n=r[o],i=n.delay===null?t.delayIndex:n.delay;return r[o].delay=i,i===0&&r[o].classList.push("no-animation"),S(C({},t),{texts:r,delayIndex:i===0?1:t.delayIndex+1});case"add_choice":return S(C({},t),{choices:t.choices.concat(e.payload)});case"delay_choice":const{index:s}=e.payload,p=t.choices,g=p[s],m=g.delay===null?t.delayIndex:g.delay;return p[s].delay=m,S(C({},t),{choices:p,delayIndex:t.delayIndex+1});case"clear_choices":return S(C({},t),{choices:[],delayIndex:1});default:throw new Error}}const ue=({story:t,className:e})=>{const[o,r]=a.exports.useState(t),[n,i]=a.exports.useReducer(de,P),[s,p]=a.exports.useState([]),g=a.exports.useRef(n.texts),m=a.exports.useRef(null),v=()=>{if(o===null)return;const d=s.slice(0,-1);o.ResetState(),p(d),r(null),setTimeout(()=>{r(o)},0)};if(a.exports.useEffect(()=>{r(t)},[t]),a.exports.useLayoutEffect(()=>{if(o!==null){for(let d of s)try{_(o,i,d)}catch{console.log(`Could not choose ${d}`),p(s.slice(0,s.indexOf(d)));break}return _(o,i,null),()=>{i({type:"reset"})}}},[o]),a.exports.useLayoutEffect(()=>{if(m.current===null)return;const d=g.current,y=n.texts;for(let b of y)if(d.indexOf(b)===-1){const M=y.indexOf(b);i({type:"delay_text",payload:{index:M}})}for(let b of x){if(b.delay!==null)continue;const I=x.indexOf(b);i({type:"delay_choice",payload:{index:I}})}g.current=y;const h=m.current.querySelector("p:last-child");h&&h.scrollIntoView({behavior:"smooth",block:"end",inline:"nearest"})},[o,n.texts,n.choices]),o===null)return null;const{texts:k,choices:x}=n,E=d=>y=>{y.preventDefault(),i({type:"clear_choices"});const h=[...s,d];p(h),o.ChooseChoiceIndex(d),_(o,i)};return w("div",{className:"player-wrapper",children:[c("div",{className:"toolbar ",children:c("div",{className:"actions-container",children:c("div",{className:"action-item icon",children:c("a",{className:"action-label codicon codicon-debug-step-back",style:{color:"rgb(248, 248, 242)"},onClick:v})})})}),w("div",{className:`container ${e}`,ref:m,children:[k.map((d,y)=>c("p",{className:d.classList.join(" "),style:{animationDelay:d.delay*200+"ms"},children:d.text},y)),x.length>0&&x.map(d=>c("p",{className:"choice",style:{animationDelay:d.delay*200+"ms"},children:c("a",{href:"#",onClick:E(d.index),children:d.text})},`choice-${s.length}-${d.index}`)),c("p",{})]})]})};function _(t,e,o){const r=o!==void 0?0:null;for(;t.canContinue;){var n=t.Continue(),i=t.currentTags;e({type:"add_text",payload:H(L(n),r)}),i&&i.length>0&&e({type:"add_text",payload:H(L(i.map(s=>`#${s}`).join(" "),["tags"]),r)})}if(o!=null){t.ChooseChoiceIndex(o);return}t.currentChoices.forEach(function(s,p){e({type:"add_choice",payload:ae(s.text,s.index)})})}const pe=({toggleFileManager:t,playerActive:e,setPlayerActive:o,editorActive:r,setEditorActive:n})=>c("div",{className:"left-bar",children:c("div",{className:"monaco-action-bar vertical",children:w("ul",{className:"actions-container",role:"toolbar","aria-label":"Active View Switcher",children:[w("li",{className:"action-item icon checked mobile-show",role:"tab",children:[c("a",{className:"action-label codicon codicon-edit-icon",style:{color:"rgb(248, 248, 242)"},onClick:()=>{o(!1),n(!0)}}),c("div",{className:"active-item-indicator"})]}),r&&w("li",{className:"action-item icon",role:"tab",children:[c("a",{className:"action-label codicon codicon-explorer-view-icon",style:{color:"rgb(248, 248, 242)"},onClick:t}),c("div",{className:"active-item-indicator"})]}),w("li",{className:"action-item icon checked mobile-show",role:"tab",children:[c("a",{className:"action-label codicon codicon-play-icon",style:{color:"rgb(248, 248, 242)"},onClick:()=>{o(!0),n(!1)}}),c("div",{className:"active-item-indicator"})]})]})})});function he(){const[t,e]=a.exports.useState(null),[o,r]=a.exports.useState(!1),[n,i]=a.exports.useState(!0),[s,p]=a.exports.useState(!1);return c("div",{className:"App",children:w("div",{className:"row",children:[c(pe,{toggleFileManager:()=>{p(!s)},playerActive:o,setPlayerActive:r,editorActive:n,setEditorActive:i}),c(le,{className:n?"":"mobile-hide",setStory:e,showFileManager:s}),c(ue,{story:t,className:o?"":"mobile-hide"})]})})}X.render(c(Z.StrictMode,{children:c(he,{})}),document.getElementById("root"));
