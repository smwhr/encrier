var B=Object.defineProperty,U=Object.defineProperties;var W=Object.getOwnPropertyDescriptors;var P=Object.getOwnPropertySymbols;var q=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable;var I=(e,t,n)=>t in e?B(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,E=(e,t)=>{for(var n in t||(t={}))q.call(t,n)&&I(e,n,t[n]);if(P)for(var n of P(t))F.call(t,n)&&I(e,n,t[n]);return e},O=(e,t)=>U(e,W(t));import{r as f,l as K,u as V,a as z,s as J,C as D,j as g,b as j,R as Q,c as X}from"./vendor.b8e7570c.js";const Y=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))d(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const p of r.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&d(p)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerpolicy&&(r.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?r.credentials="include":o.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function d(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}};Y();const Z=e=>!!(e==null?void 0:e[Symbol.iterator]),H=({setStory:e})=>{const t=`LIST letters = a,b,c
    Once upon a time...
    -(opts)
    + Choice A.
    + Choice B.
    + Choice C.
   
   - They lived happily ever after {opts}.
       -> opts
   `,n=f.exports.useRef(null),[d,o]=f.exports.useState([]),[r,p]=f.exports.useState(),R=K(a=>d.map(l=>{const u=a.lineBlockAt(l.index);return{from:u.from,to:u.to,severity:l.type.includes("ERROR")?"error":l.type.includes("WARNING")?"warning":"info",message:l.msg}})),S=a=>{if(r===void 0)return["Could not parse story"];const l=a.selection.ranges[0];let u=a.doc.lineAt(l.head),y=u.number,C=l.head-u.from;const N=c=>c.GetType()=="Text"&&c.text==`
`,L=(c,x,s)=>c>=s.startLineNumber&&c<=s.endLineNumber&&(s.startLineNumber!=s.endLineNumber&&(c==s.startLineNumber&&x>=s.startCharacterNumber||c==s.endLineNumber&&x<s.endCharacterNumber||c>s.startLineNumber&&c<s.endLineNumber)||s.startLineNumber==s.endLineNumber&&x>=s.startCharacterNumber&&x<s.endCharacterNumber),w=(c,x=[])=>{if(c.debugMetadata!==null&&!L(y,C,c.debugMetadata))return null;if(!Z(c.content)||c.content.length==0){const b=c.debugMetadata;return b===null?null:L(y,C,b)?[...x].concat(c):null}const s=c.content;for(let b of s){const A=[...x].concat(c),v=w(b,A);if(v!==null)return v.length>0&&N(v[v.length-1])&&v.splice(-1,1),v}return[...x].concat(c)},m=w(r);return console.log(m),(m==null?void 0:m.map(c=>c.GetType()))||[]};function _(a){let l=document.createElement("div");return l.textContent="Story compiled successfully",{dom:l,update(u){var y;u.selectionSet&&(l.textContent=((y=S(a.state))==null?void 0:y.join(" > "))||"Could not parse at position")}}}const{setContainer:i}=V({container:n.current,extensions:[R,z(),J.of(_)],value:t,minHeight:"100%",height:"100%",theme:"dark",onChange:(a,l)=>{h(a)}}),h=a=>{const l=[],u=(N,L)=>{var w=/^(ERROR|WARNING|RUNTIME ERROR|RUNTIME WARNING|TODO): ('([^']+)' )?line (\d+): (.*)/;let m=N.match(w);if(m){const c=m[1],x=m[3],s=parseInt(m[4]),b=m[5],A=/\n/gi,v=[];let M=null;for(;M=A.exec(a);)v.push(M.index+1);const $=v[s-1]||0;l.push({type:c,filename:x,lineNumber:s,index:$,msg:b})}},y=new D.CompilerOptions(null,[],!1,u,null),C=new D.Compiler(a,y);try{const N=C.Compile(),L=C.parsedStory;p(L),e(N)}catch(N){p(void 0),console.error(N)}finally{o(l)}};return f.exports.useEffect(()=>{h(t)},[]),f.exports.useEffect(()=>{n.current&&i(n.current)},[n.current]),g("div",{className:"editor",ref:n})},ee=(e,t)=>({text:e,index:t,delay:0}),G=(e,t=[])=>({text:e,classList:t,delay:0}),k={texts:[],choices:[]};function te(e,t){switch(t.type){case"reset":return k;case"add_text":return O(E({},e),{texts:e.texts.concat(t.payload)});case"delay_text":const{index:n,delay:d}=t.payload,o=e.texts;return o[n].delay=d,O(E({},e),{texts:o});case"add_choice":return O(E({},e),{choices:e.choices.concat(t.payload)});case"delay_choice":const{index:r,delay:p}=t.payload,R=e.choices;return R[r].delay=p,O(E({},e),{choices:R});case"clear_choices":return O(E({},e),{choices:[]});default:throw new Error}}const ne=({story:e})=>{const[t,n]=f.exports.useReducer(te,k),[d,o]=f.exports.useState([]),r=f.exports.useRef(t.texts),p=f.exports.useRef(null);if(f.exports.useLayoutEffect(()=>{if(e!==null){for(let i of d)try{T(e,n,i)}catch{console.log(`Could not choose ${i}`),o(d.slice(0,d.indexOf(i)));break}return T(e,n),()=>{n({type:"reset"})}}},[e]),f.exports.useLayoutEffect(()=>{if(p.current===null)return;const i=r.current,h=t.texts;let a=0;for(let u of h)if(i.indexOf(u)===-1){const C=h.indexOf(u),N=a*200;n({type:"delay_text",payload:{index:C,delay:N}}),a++}for(let u of S){if(u.delay>0)continue;const y=S.indexOf(u),C=a*200;n({type:"delay_choice",payload:{index:y,delay:C}}),a++}r.current=h;const l=p.current.querySelector("p:last-child");l&&l.scrollIntoView({behavior:"smooth",block:"end",inline:"nearest"})},[e,t.texts,t.choices]),e===null)return null;const{texts:R,choices:S}=t,_=i=>h=>{h.preventDefault(),n({type:"clear_choices"}),o(d.concat(i)),e.ChooseChoiceIndex(i),T(e,n)};return j("div",{className:"container",ref:p,children:[R.map((i,h)=>g("p",{style:{animationDelay:i.delay+200+"ms"},children:i.text},h)),S.length>0&&S.map(i=>g("p",{className:"choice",style:{animationDelay:i.delay+200+"ms"},children:g("a",{href:"#",onClick:_(i.index),children:i.text})},`choice-${d.length}-${i.index}`)),g("p",{})]})};function T(e,t,n){for(;e.canContinue;){var d=e.Continue(),o=e.currentTags;t({type:"add_text",payload:G(d)}),o&&o.length>0&&t({type:"add_text",payload:G(o.map(r=>`#${r}`).join(" "),["tags"])})}if(n!==void 0){e.ChooseChoiceIndex(n);return}e.currentChoices.forEach(function(r,p){t({type:"add_choice",payload:ee(r.text,r.index)})})}function oe(){f.exports.useState(0);const[e,t]=f.exports.useState(null);return g("div",{className:"App",children:j("div",{className:"row",children:[g(H,{setStory:t}),g(ne,{story:e})]})})}Q.render(g(X.StrictMode,{children:g(oe,{})}),document.getElementById("root"));
